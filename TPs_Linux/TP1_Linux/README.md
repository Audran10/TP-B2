# TP1 - (re)Familiaration avec un système GNU/Linux
# 0 - Préparation de la machine
## 1) Un accès internet (via la carte NAT)
<br/>
On ajoute une carte NAT en adapter1 sur VBox et on vérifie :

```
[audran@node1 ~]$ ip a
2: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:cf:38:43 brd ff:ff:ff:ff:ff:ff
    inet 10.0.2.15/24 brd 10.0.2.255 scope global dynamic noprefixroute enp0s3
       valid_lft 85317sec preferred_lft 85317sec
    inet6 fe80::a00:27ff:fecf:3843/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
```
On a notre carte NAT avec une route par défaut.

<br/>

## 2) Un accès à un réseau local
<br/>
On ajoute une carte Host-only dans VBox et on vérifie :

```
[audran@node1 ~]$ ip a
3: enp0s8: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:be:99:9c brd ff:ff:ff:ff:ff:ff
    inet 10.101.1.11/24 brd 10.101.1.255 scope global noprefixroute enp0s8
       valid_lft forever preferred_lft forever
    inet6 fe80::a00:27ff:febe:999c/64 scope link
       valid_lft forever preferred_lft forever
```
On a notre carte host-only qui a une IP.

<br/>

## 4) Les machines doivent avoir un nom
<br/>

```
[audran@node1 ~]$ sudo nano /etc/hostanme
node1.tp1.b2

[audran@node1 ~]$ hostname
node1.tp1.b2
```

<br/>

## 5) Utiliser 1.1.1.1 comme serveur DNS
<br/>

```
[audran@node1 ~]$ cat /etc/resolv.conf
# Generated by NetworkManager
search tp1.b2
nameserver 1.1.1.1

[audran@node1 ~]$ dig ynov.com
; <<>> DiG 9.16.23-RH <<>> ynov.com
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 10625
;; flags: qr rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
;; QUESTION SECTION:
;ynov.com.                      IN      A

;; ANSWER SECTION:
ynov.com.               300     IN      A       104.26.10.233
ynov.com.               300     IN      A       172.67.74.226
ynov.com.               300     IN      A       104.26.11.233

;; Query time: 32 msec
;; SERVER: 1.1.1.1#53(1.1.1.1)
;; WHEN: Mon Nov 14 12:01:48 CET 2022
;; MSG SIZE  rcvd: 85
```

- IP qui correspond au nom demandé

```
ynov.com.               300     IN      A       104.26.10.233
```

- IP du serveur qui vous a répondu
```
;; SERVER: 1.1.1.1#53(1.1.1.1)
```

<br/>

## 6) Les machines doivent pouvoir se joindre par leurs noms respectifs
<br/>

```
[audran@node1 ~]$ sudo nano /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
10.101.1.11 node1 node1.tp1 node1.tp1.b2

[audran@node1 ~]$ ping node1.tp1
PING node1 (10.101.1.11) 56(84) bytes of data.
64 bytes from node1 (10.101.1.11): icmp_seq=1 ttl=64 time=0.026 ms
64 bytes from node1 (10.101.1.11): icmp_seq=2 ttl=64 time=0.033 ms
```

<br/>

## 7) Le pare-feu
```
[audran@node1 ~]$ sudo firewall-cmd --list-all
[sudo] password for audran:
public (active)
  target: default
  icmp-block-inversion: no
  interfaces: enp0s3 enp0s8
  sources:
  services: cockpit dhcpv6-client ssh
  ports:
  protocols:
  forward: yes
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules:
```

<br/>

# I - Utilisateurs
## 1. Création et configuration
### A) Ajouter un utilisateur à la machine
<br/>

```
[audran@node1 ~]$ useradd audran10 -m -s /bin/bash -u 2000

[audran@node1 ~]$ cat /etc/passwd
audran10:x:2000:2000::/home/audran10:/bin/bash
```
Mon utilisateur est bien dans /home est il utilise le bon shell à savoir /bin/bash.

<br/>

### B) Créer un nouveau groupe
<br/>

```
[audran@node1 ~]$ sudo groupadd admins
[audran@node1 ~]$ sudo visudo
%admins ALL=(ALL)    ALL
```

<br/>

### C) Ajouter votre utilisateur à ce groupe admins
<br/>

```
[audran@node1 etc]$ sudo usermod -aG admins audran10

[audran10@node1 ~]$ sudo visudo

We trust you have received the usual lecture from the local System
Administrator. It usually boils down to these three things:

    #1) Respect the privacy of others.
    #2) Think before you type.
    #3) With great power comes great responsibility.

[sudo] password for audran10:
visudovisudo: /etc/sudoers.tmp unchanged
```

Le sudo a bien été accepté avec l'utilisateur audran10.

<br/>

## 2) SSH
<br/>

```
PS C:\Users\Audran> ssh-keygen -t rsa -b 4096
Your public key has been saved in C:\Users\Audran/.ssh/id_rsa.pub.

PS C:\Users\Audran> ssh-copy-id audran10@10.101.1.11

PS C:\Users\Audran> ssh audran10@10.101.1.11
Last login: Mon Nov 14 17:00:26 2022 from 10.101.1.1
[audran10@node1 ~]$
```

<br/>

# II. Partitionnement
## 2) Partitionnement
<br/>
On repère nos 2 disques de 3G sdb et sdc que l'on a crée :

```
[audran10@node1 ~]$ lsblk
NAME        MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS
sda           8:0    0    8G  0 disk
├─sda1        8:1    0    1G  0 part /boot
└─sda2        8:2    0    7G  0 part
  ├─rl-root 253:0    0  6.2G  0 lvm  /
  └─rl-swap 253:1    0  820M  0 lvm  [SWAP]
sdb           8:16   0    3G  0 disk
sdc           8:32   0    3G  0 disk
sr0          11:0    1 1024M  0 rom
sr1          11:1    1 1024M  0 rom
```

```
[audran10@node1 ~]$ sudo pvcreate /dev/sdb
  Physical volume "/dev/sdb" successfully created.
[audran10@node1 ~]$ sudo pvcreate /dev/sdc
  Physical volume "/dev/sdc" successfully created.
[audran10@node1 ~]$ sudo pvs
  PV         VG Fmt  Attr PSize  PFree
  /dev/sda2  rl lvm2 a--  <7.00g    0
  /dev/sdb      lvm2 ---   3.00g 3.00g
  /dev/sdc      lvm2 ---   3.00g 3.00g
```

Ajout des PVs aux VG :
```
[audran10@node1 ~]$ sudo vgcreate data /dev/sdb
  Volume group "data" successfully created
[audran10@node1 ~]$ sudo vgextend data /dev/sdc
  Volume group "data" successfully extended
[audran10@node1 ~]$ sudo vgs
  VG   #PV #LV #SN Attr   VSize  VFree
  data   2   0   0 wz--n-  5.99g 5.99g
```

Création des 3 LVs de 1G :

```
[audran10@node1 ~]$ sudo lvcreate -L 1G data -n LV1
  Logical volume "LV1" created.
[audran10@node1 ~]$ sudo lvcreate -L 1G data -n LV2
  Logical volume "LV2" created.
[audran10@node1 ~]$ sudo lvcreate -L 1G data -n LV3
  Logical volume "LV3" created.
[audran10@node1 ~]$ sudo lvs
  LV   VG   Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  LV1  data -wi-a-----   1.00g
  LV2  data -wi-a-----   1.00g
  LV3  data -wi-a-----   1.00g
```

Formatage en ext4 :

```
[audran10@node1 ~]$ sudo mkfs -t ext4 /dev/data/LV1
mke2fs 1.46.5 (30-Dec-2021)
Creating filesystem with 262144 4k blocks and 65536 inodes
Filesystem UUID: 76c148f1-c976-49fc-a1c3-fdc37cd3c4ba
Superblock backups stored on blocks:
        32768, 98304, 163840, 229376

Allocating group tables: done
Writing inode tables: done
Creating journal (8192 blocks): done
Writing superblocks and filesystem accounting information: done

[audran10@node1 ~]$ sudo mkfs -t ext4 /dev/data/LV2
mke2fs 1.46.5 (30-Dec-2021)
Creating filesystem with 262144 4k blocks and 65536 inodes
Filesystem UUID: fc663b17-689d-44b9-ac69-c5122a2ccb84
Superblock backups stored on blocks:
        32768, 98304, 163840, 229376

Allocating group tables: done
Writing inode tables: done
Creating journal (8192 blocks): done
Writing superblocks and filesystem accounting information: done

[audran10@node1 ~]$ sudo mkfs -t ext4 /dev/data/LV3
mke2fs 1.46.5 (30-Dec-2021)
Creating filesystem with 262144 4k blocks and 65536 inodes
Filesystem UUID: 3bb1a9b7-5319-4d5b-b864-6e582506d3e4
Superblock backups stored on blocks:
        32768, 98304, 163840, 229376

Allocating group tables: done
Writing inode tables: done
Creating journal (8192 blocks): done
Writing superblocks and filesystem accounting information: done
```

Montage des partitions :

```
[audran10@node1 ~]$ sudo mkdir /mnt/part1
[audran10@node1 ~]$ sudo mkdir /mnt/part2
[audran10@node1 ~]$ sudo mkdir /mnt/part3
[audran10@node1 ~]$ sudo mount /dev/data/LV1 /mnt/part1/
[audran10@node1 ~]$ sudo mount /dev/data/LV2 /mnt/part2/
[audran10@node1 ~]$ sudo mount /dev/data/LV3 /mnt/part3/

[audran10@node1 ~]$ sudo mount
/dev/mapper/data-LV1 on /mnt/part1 type ext4 (rw,relatime,seclabel)
/dev/mapper/data-LV2 on /mnt/part2 type ext4 (rw,relatime,seclabel)
/dev/mapper/data-LV3 on /mnt/part3 type ext4 (rw,relatime,seclabel)
```

Partitionnement automatique :
- part1 :

```
[audran10@node1 ~]$ sudo umount /mnt/part1
[audran10@node1 ~]$ sudo mount -av
/mnt/part1               : successfully mounted
```

- part2 :

```
[audran10@node1 ~]$ sudo umount /mnt/part2
[audran10@node1 ~]$ sudo mount -av
/mnt/part2               : successfully mounted
```

- part3 :

```
[audran10@node1 ~]$ sudo umount /mnt/part3
[audran10@node1 ~]$ sudo mount -av
/mnt/part3               : successfully mounted
```

<br/>

# III. Gestion de services
## 1) Interaction avec un service existant
<br/>

```
[audran10@node1 ~]$ systemctl is-active firewalld.service
active

[audran10@node1 ~]$ systemctl is-enabled firewalld.service
enabled
```

<br/>

## 2) Création de service
### A) Unité simpliste
<br/>

```
[audran10@node1 ~]$ sudo nano /etc/systemd/system/web.service

[Unit]
Description=Very simple web service

[Service]
ExecStart=/usr/bin/python3 -m http.server 8888

[Install]
WantedBy=multi-user.target
```

Ouverture du port 8888 dans le firewall :

```
[audran10@node1 ~]$ sudo firewall-cmd --add-port=8888/tcp --permanent
success
[audran10@node1 ~]$ sudo firewall-cmd --reload
success
[audran10@node1 ~]$ sudo firewall-cmd --list-all
ports: 8888/tcp
```

Vérification :

```
[audran10@node1 ~]$ sudo systemctl daemon-reload
[audran10@node1 ~]$ sudo systemctl start web
[audran10@node1 ~]$ sudo systemctl enable web
Created symlink /etc/systemd/system/multi-user.target.wants/web.service → /etc/systemd/system/web.service.
[audran10@node1 ~]$ sudo systemctl status web
● web.service - Very simple web service
     Loaded: loaded (/etc/systemd/system/web.service; enabled; vendor preset: disabled)
     Active: active (running) since Mon 2022-11-14 18:45:14 CET; 21s ago
```

Une fois le service démarré, assurez-vous que pouvez accéder au serveur web :

```
[audran@node2 ~]$ curl 10.101.1.11:8888
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Directory listing for /</title>
</head>
<body>
<h1>Directory listing for /</h1>
<hr>
<ul>
<li><a href="afs/">afs/</a></li>
<li><a href="bin/">bin@</a></li>
<li><a href="boot/">boot/</a></li>
<li><a href="dev/">dev/</a></li>
<li><a href="etc/">etc/</a></li>
<li><a href="home/">home/</a></li>
<li><a href="lib/">lib@</a></li>
<li><a href="lib64/">lib64@</a></li>
<li><a href="media/">media/</a></li>
<li><a href="mnt/">mnt/</a></li>
<li><a href="opt/">opt/</a></li>
<li><a href="proc/">proc/</a></li>
<li><a href="root/">root/</a></li>
<li><a href="run/">run/</a></li>
<li><a href="sbin/">sbin@</a></li>
<li><a href="srv/">srv/</a></li>
<li><a href="sys/">sys/</a></li>
<li><a href="tmp/">tmp/</a></li>
<li><a href="usr/">usr/</a></li>
<li><a href="var/">var/</a></li>
</ul>
<hr>
</body>
</html>
```

```
PS C:\Users\Audran> curl 10.101.1.11:8888                                                                               

StatusCode        : 200
StatusDescription : OK
Content           : <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
                    <html>
                    <head>
                    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
                    <title>Directory listing fo...
RawContent        : HTTP/1.0 200 OK
                    Content-Length: 975
                    Content-Type: text/html; charset=utf-8
                    Date: Mon, 14 Nov 2022 18:12:04 GMT
                    Server: SimpleHTTP/0.6 Python/3.9.10

                    <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01/...
Forms             : {}
Headers           : {[Content-Length, 975], [Content-Type, text/html; charset=utf-8], [Date, Mon, 14 Nov 2022 18:12:04
                    GMT], [Server, SimpleHTTP/0.6 Python/3.9.10]}
Images            : {}
InputFields       : {}
Links             : {@{innerHTML=afs/; innerText=afs/; outerHTML=<A href="afs/">afs/</A>; outerText=afs/; tagName=A;
                    href=afs/}, @{innerHTML=bin@; innerText=bin@; outerHTML=<A href="bin/">bin@</A>; outerText=bin@;
                    tagName=A; href=bin/}, @{innerHTML=boot/; innerText=boot/; outerHTML=<A href="boot/">boot/</A>;
                    outerText=boot/; tagName=A; href=boot/}, @{innerHTML=dev/; innerText=dev/; outerHTML=<A
                    href="dev/">dev/</A>; outerText=dev/; tagName=A; href=dev/}...}
ParsedHtml        : mshtml.HTMLDocumentClass
RawContentLength  : 975
```

<br/>


### B. Modification de l'unité
<br/>

Préparez l'environnement pour exécuter le mini serveur web Python :

- créer un utilisateur web
```
[audran10@node1 ~]$ sudo useradd web -m -s /bin/bash
```

- créer un dossier /var/www/meow/
```
[audran10@node1 ~]$ sudo mkdir /var/www
[audran10@node1 ~]$ sudo mkdir /var/www/meow
```

- créer un fichier dans le dossier /var/www/meow/ 
```
[audran10@node1 ~]$ sudo touch /var/www/meow/test
[audran10@node1 ~]$ sudo chown web /var/www/meow/test
```

- montrez à l'aide d'une commande les permissions positionnées sur le dossier et son contenu

```
[audran10@node1 ~]$ ls -al /var/www/meow/test
-rw-r--r--. 1 web root 0 Nov 14 19:19 /var/www/meow/test
```

Modifiez l'unité de service web.service créée précédemment en ajoutant les clauses :

```
[audran10@node1 ~]$ sudo nano /etc/systemd/system/web.service

[Unit]
Description=Very simple web service

[Service]
ExecStart=/usr/bin/python3 -m http.server 8888
User=web
WorkingDirectory=/var/www/meow/
[Install]
WantedBy=multi-user.target
```

Vérifiez le bon fonctionnement avec une commande curl :

```
[audran10@node1 ~]$ sudo systemctl status web.service
● web.service - Very simple web service
     Loaded: loaded (/etc/systemd/system/web.service; enabled; vendor preset: disabled)
     Active: active (running) since Mon 2022-11-14 18:45:14 CET; 41min ago
   Main PID: 1232 (python3)
      Tasks: 1 (limit: 5907)
     Memory: 9.3M
        CPU: 241ms
     CGroup: /system.slice/web.service
             └─1232 /usr/bin/python3 -m http.server 8888

Nov 14 18:45:14 node1.tp1.b2 systemd[1]: Started Very simple web service.
```

```
[audran@node2 ~]$ curl 10.101.1.11:8888
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Directory listing for /</title>
</head>
<body>
<h1>Directory listing for /</h1>
<hr>
<ul>
<li><a href="afs/">afs/</a></li>
<li><a href="bin/">bin@</a></li>
<li><a href="boot/">boot/</a></li>
<li><a href="dev/">dev/</a></li>
<li><a href="etc/">etc/</a></li>
<li><a href="home/">home/</a></li>
<li><a href="lib/">lib@</a></li>
<li><a href="lib64/">lib64@</a></li>
<li><a href="media/">media/</a></li>
<li><a href="mnt/">mnt/</a></li>
<li><a href="opt/">opt/</a></li>
<li><a href="proc/">proc/</a></li>
<li><a href="root/">root/</a></li>
<li><a href="run/">run/</a></li>
<li><a href="sbin/">sbin@</a></li>
<li><a href="srv/">srv/</a></li>
<li><a href="sys/">sys/</a></li>
<li><a href="tmp/">tmp/</a></li>
<li><a href="usr/">usr/</a></li>
<li><a href="var/">var/</a></li>
</ul>
<hr>
</body>
</html>
```

